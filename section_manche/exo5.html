<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exo 5 : Le Puzzle</title>
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --success: #10b981;
            --danger: #ef4444;
            --secondary: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.9);
            --text-main: #f1f5f9;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background:
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(260,39%,30%,1) 0, transparent 50%);
            background-color: #0f172a;
            background-attachment: fixed;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .nav-btn {
            position: absolute; top: 25px; left: 25px;
            text-decoration: none; color: rgba(255, 255, 255, 0.8);
            font-weight: 600; padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1); border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.25); color: white; }

        .container {
            background: var(--card-bg);
            padding: 30px; border-radius: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center; max-width: 1000px; width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* MANCHE */
        .fretboard-wrapper {
            position: relative; background: #18181b;
            padding: 10px 40px 10px 60px; border-radius: 15px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
            margin: 20px 0; border: 4px solid #3f3f46;
            overflow: hidden; user-select: none;
        }

        .string-names {
            position: absolute; left: 5px; top: 0; bottom: 0;
            display: flex; flex-direction: column; justify-content: space-around;
            font-weight: bold; color: #94a3b8; font-size: 0.8rem; padding: 10px 0;
            width: 45px; text-align: right; pointer-events: none;
        }

        .fretboard { display: grid; grid-template-columns: 50px repeat(12, 1fr); position: relative; height: 220px; }
        .fret-line { border-right: 3px solid #a1a1aa; position: relative; z-index: 1; pointer-events: none; }
        .nut { background-color: #fce7f3; border-right: 6px solid #e5e7eb; }

        /* Cordes visuelles */
        .string-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2; pointer-events: none; }
        .string { position: absolute; left: 60px; right: 40px; background: linear-gradient(to bottom, #d4d4d8, #71717a); box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .str-0 { top: 15%; height: 1.5px; } .str-1 { top: 29%; height: 2px; } .str-2 { top: 43%; height: 2.5px; }
        .str-3 { top: 57%; height: 3.5px; } .str-4 { top: 71%; height: 4px; } .str-5 { top: 85%; height: 5px; }

        .marker { position: absolute; width: 18px; height: 18px; background: radial-gradient(circle, #fff 0%, #cbd5e1 100%); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0; }
        .marker-double { height: 50px; width: 18px; border-radius: 10px; }

        /* ZONES CLIQUABLES */
        .click-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10;
            display: grid; grid-template-columns: 50px repeat(12, 1fr);
            grid-template-rows: repeat(6, 1fr);
            padding: 10px 40px 10px 60px;
        }

        .click-zone {
            cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
        }

        /* Hover seulement si case vide */
        .click-zone:not(.filled):hover::after {
            content: ''; width: 20px; height: 20px; background: rgba(255,255,255,0.2); border-radius: 50%;
        }

/* PASTILLES VALIDEES (Version muette) */
        .note-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4ade80, #16a34a); /* Effet bille */
            box-shadow: 0 0 10px var(--success);
            z-index: 20;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes pulseTarget { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .click-zone.error { animation: shake 0.3s; background: rgba(239, 68, 68, 0.3); border-radius: 50%; }

        /* UI CIBLE (Target) */
        .game-controls {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }

        .target-box {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            padding: 20px 40px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 200px;
        }

        .target-label { color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }

        .target-note {
            font-size: 4rem;
            font-weight: 900;
            color: var(--primary-light);
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.4);
            animation: pulseTarget 2s infinite;
            line-height: 1;
        }

        .remaining-info {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Barre de progression globale */
        .progress-container {
            width: 100%; max-width: 600px; margin: 0 auto 30px auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .progress-label { color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px; width: 100%; display: flex; justify-content: space-between; }
        .progress-track { width: 100%; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--success)); transition: width 0.3s; }

        /* VICTOIRE */
        .victory-modal {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(15, 23, 42, 0.98); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            display: none; animation: fadeIn 0.5s;
        }
        .victory-title { font-size: 3rem; color: var(--success); margin-bottom: 20px; text-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
        .btn-restart {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            color: white; border: none; padding: 15px 40px; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
        }

        /* HEADER INFO (Timer + Record) */
        .header-info {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; font-weight: 700; color: #94a3b8;
        }
        .record-badge {
            font-size: 0.9rem; background: rgba(255,255,255,0.1);
            padding: 6px 12px; border-radius: 12px; color: #cbd5e1;
        }
        .timer-display {
            font-size: 1.5rem; color: var(--primary-light); font-variant-numeric: tabular-nums;
        }

        /* Ajouts pour la modale de victoire */
        .final-time { font-size: 1.5rem; color: white; margin-bottom: 20px; font-weight: bold; }
        .new-record-msg { color: var(--gold); font-weight: 800; font-size: 1.2rem; margin-bottom: 30px; animation: pulseTarget 1s infinite; display: none;}

    </style>
</head>
<body>

    <a href="../section_manche.html" class="nav-btn">‚Üê Retour</a>

    <div class="container">

        <div class="header-info">
            <span class="record-badge" id="recordDisplay">Record: --:--</span>
            <div style="text-align: right;">
                <span style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; display:block;">Temps</span>
                <span class="timer-display" id="timerDisplay">00:00</span>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-label">
                <span>Progression du Puzzle</span>
                <span id="globalCount">0 / 60</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="fretboard-wrapper">
            <div class="string-names">
                <span>e</span><span>Si</span><span>Sol</span><span>R√©</span><span>La</span><span>Mi</span>
            </div>

            <div class="fretboard" id="fretboardVisual"></div>

            <div class="string-layer">
                <div class="string str-0"></div><div class="string str-1"></div><div class="string str-2"></div>
                <div class="string str-3"></div><div class="string str-4"></div><div class="string str-5"></div>
            </div>

            <div class="click-layer" id="clickLayer"></div>
        </div>

        <div class="game-controls">
            <div class="target-box">
                <span class="target-label">Placez un</span>
                <div class="target-note" id="targetNoteDisplay">?</div>
                <div class="remaining-info" id="remainingForNote">Reste √† trouver : -</div>
            </div>
        </div>

        <div class="victory-modal" id="victoryModal">
            <div class="victory-title">PUZZLE COMPL√âT√â !</div>
            <div class="final-time" id="finalTimeDisplay">Temps : 00:00</div>
            <div class="new-record-msg" id="newRecordMsg">üèÜ NOUVEAU RECORD !</div>
            <button class="btn-restart" onclick="initGame()">Recommencer</button>
        </div>

    </div>

<script>
    // --- DATA ---
    const stringOffsets = [4, 11, 7, 2, 9, 4]; // e B G D A E
    const noteNames = ["Do", "Do#", "R√©", "R√©#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];

    // --- STATE ---
    let stock = {}; // { 0: 5, 1: 5 ... } Stock restant pour chaque note
    let currentTargetIndex = -1; // La note que le joueur doit placer MAINTENANT
    let totalToFind = 0;
    let totalFound = 0;

    // CHRONO
    let startTime = 0;
    let timerInterval = null;
    const STORAGE_KEY = "guitar_exo5_best_time";


    // DOM
    const clickLayer = document.getElementById('clickLayer');
    const visualBoard = document.getElementById('fretboardVisual');
    const victoryModal = document.getElementById('victoryModal');
    const targetNoteDisplay = document.getElementById('targetNoteDisplay');
    const remainingForNote = document.getElementById('remainingForNote');
    const progressFill = document.getElementById('progressFill');
    const globalCount = document.getElementById('globalCount');
    const timerDisplay = document.getElementById('timerDisplay');
    const recordDisplay = document.getElementById('recordDisplay');
    const finalTimeDisplay = document.getElementById('finalTimeDisplay');
    const newRecordMsg = document.getElementById('newRecordMsg');

    /* --- CHRONOM√àTRE & RECORD --- */
    function startTimer() {
        startTime = Date.now();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            let elapsed = Date.now() - startTime;
            timerDisplay.textContent = formatTime(elapsed);
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        return Date.now() - startTime;
    }

    function formatTime(ms) {
        let seconds = Math.floor(ms / 1000);
        let minutes = Math.floor(seconds / 60);
        seconds = seconds % 60;
        return `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function loadRecord() {
        let rec = localStorage.getItem(STORAGE_KEY);
        recordDisplay.textContent = rec ? "Record: " + formatTime(parseInt(rec)) : "Record: --:--";
    }

    function saveRecord(ms) {
        let currentRecord = localStorage.getItem(STORAGE_KEY);
        if(!currentRecord || ms < parseInt(currentRecord)) {
            localStorage.setItem(STORAGE_KEY, ms);
            newRecordMsg.style.display = 'block';
            loadRecord();
        }
    }

function initGame() {
        victoryModal.style.display = 'none';
        newRecordMsg.style.display = 'none';
        totalFound = 0;

        loadRecord(); // Charger le record

        // Calcul stock
        stock = calculateRealStock();
        totalToFind = Object.values(stock).reduce((a, b) => a + b, 0);

        updateProgress();
        buildVisualBoard();
        buildClickLayer();

        startTimer(); // Lancer le chrono
        pickNewTarget();
    }

    function calculateRealStock() {
        let counts = Array(12).fill(0);
        for(let s=0; s<6; s++) {
            for(let f=0; f<=12; f++) {
                let noteVal = (stringOffsets[s] + f) % 12;
                counts[noteVal]++;
            }
        }
        return counts;
    }

    function buildVisualBoard() {
        visualBoard.innerHTML = '';
        for(let i=0; i<=12; i++) {
            let div = document.createElement('div');
            div.className = i === 0 ? 'nut' : 'fret-line';
            if ([3,5,7,9].includes(i)) {
                let m = document.createElement('div'); m.className = 'marker'; div.appendChild(m);
            }
            if (i === 12) {
                let m = document.createElement('div'); m.className = 'marker marker-double'; div.appendChild(m);
            }
            visualBoard.appendChild(div);
        }
    }

    function buildClickLayer() {
        clickLayer.innerHTML = '';
        for(let s=0; s<6; s++) {
            for(let f=0; f<=12; f++) {
                let zone = document.createElement('div');
                zone.className = 'click-zone';
                zone.dataset.string = s;
                zone.dataset.fret = f;
                // Calcul de la vraie note de cette case
                let realNote = (stringOffsets[s] + f) % 12;
                zone.dataset.note = realNote;

                zone.onclick = () => handleCaseClick(zone, realNote);
                clickLayer.appendChild(zone);
            }
        }
    }

    function pickNewTarget() {
        // Trouver quelles notes ont encore du stock
        let availableNotes = [];
        for(let i=0; i<12; i++) {
            if(stock[i] > 0) availableNotes.push(i);
        }

        if(availableNotes.length === 0) {
            winGame();
            return;
        }

        // Choisir une note au hasard parmi celles qui restent
        let randomIndex = Math.floor(Math.random() * availableNotes.length);
        currentTargetIndex = availableNotes[randomIndex];

        // Mettre √† jour l'affichage
        updateDisplay();
    }

    function updateDisplay() {
        targetNoteDisplay.textContent = noteNames[currentTargetIndex];
        // Couleur diff√©rente pour les di√®ses pour lisibilit√© ? Optionnel.

        let remaining = stock[currentTargetIndex];
        remainingForNote.textContent = `Encore ${remaining} √† trouver sur le manche`;
    }

    function handleCaseClick(zone, caseNoteVal) {
        // Si la case est d√©j√† remplie, on ne fait rien
        if(zone.classList.contains('filled')) return;

        // VERIFICATION
        if(caseNoteVal === currentTargetIndex) {
            // BRAVO
            placeNoteVisual(zone, noteNames[caseNoteVal]);
            zone.classList.add('filled');

            // D√©cr√©menter stock
            stock[currentTargetIndex]--;
            totalFound++;

            updateProgress();

            // On change de cible imm√©diatement ! (C'est le c√¥t√© al√©atoire demand√©)
            pickNewTarget();

        } else {
            // ERREUR
            zone.classList.add('error');
            setTimeout(() => zone.classList.remove('error'), 300);
        }
    }

    function placeNoteVisual(zone, text) {
        let dot = document.createElement('div');
        dot.className = 'note-dot';
        zone.appendChild(dot);
    }

    function updateProgress() {
        globalCount.textContent = `${totalFound} / ${totalToFind}`;
        let pct = (totalFound / totalToFind) * 100;
        progressFill.style.width = `${pct}%`;
    }

    function winGame() {
        let finalMs = stopTimer(); // Arr√™t du chrono

        setTimeout(() => {
            victoryModal.style.display = 'flex';
            finalTimeDisplay.textContent = "Temps : " + formatTime(finalMs);
            saveRecord(finalMs); // Check record
        }, 500);
    }

    // Lancer le jeu
    initGame();

</script>
</body>
</html>