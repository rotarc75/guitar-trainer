<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accordeur Pro</title>
    <style>
        :root {
            --primary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --secondary: #1e293b;
            --bg-dark: #0f172a;
            --text-main: #f1f5f9;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(260,39%,30%,1) 0, transparent 50%);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        /* NAVIGATION */
        .nav-back {
            position: absolute; top: 20px; left: 20px;
            text-decoration: none; color: rgba(255,255,255,0.7);
            padding: 10px 20px; border-radius: 30px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .nav-back:hover { background: rgba(255,255,255,0.15); color: white; }

        /* BOITE PRINCIPALE */
        .tuner-container {
            background: rgba(30, 41, 59, 0.6);
            padding: 40px; border-radius: 40px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
            text-align: center; width: 350px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* AFFICHAGE NOTE */
        .note-display {
            font-size: 6rem; font-weight: 900;
            color: var(--text-main);
            margin: 10px 0;
            height: 120px; line-height: 120px;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }
        .note-display.in-tune { color: var(--success); text-shadow: 0 0 40px var(--success); }

        .frequency { font-family: monospace; color: #94a3b8; font-size: 1.2rem; margin-bottom: 30px; }

        /* JAUGE (Aiguille) */
        .gauge-wrapper {
            position: relative; width: 100%; height: 20px;
            background: #334155; border-radius: 10px;
            margin: 20px 0 40px 0; overflow: hidden;
        }

        .center-line {
            position: absolute; left: 50%; top: 0; bottom: 0;
            width: 2px; background: rgba(255,255,255,0.2);
            transform: translateX(-50%); z-index: 1;
        }

        .needle {
            position: absolute; top: 0; bottom: 0; width: 6px;
            background: var(--danger); border-radius: 3px;
            left: 50%; transform: translateX(-50%);
            transition: left 0.1s linear, background-color 0.2s;
            box-shadow: 0 0 10px var(--danger);
        }
        .needle.centered { background: var(--success); box-shadow: 0 0 15px var(--success); }

        /* INDICATEURS */
        .indicators { display: flex; justify-content: space-between; font-weight: bold; color: #64748b; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; margin-top: -30px; margin-bottom: 30px;}

        /* BOUTON START */
        .btn-start {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            border: none; color: white; padding: 15px 40px;
            border-radius: 50px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 20px -5px rgba(139, 92, 246, 0.4);
        }
        .btn-start:hover { transform: translateY(-3px); box-shadow: 0 15px 25px -5px rgba(139, 92, 246, 0.5); }
        .btn-start:active { transform: scale(0.98); }

        /* STATUS MICRO */
        .mic-status { margin-top: 20px; font-size: 0.9rem; color: #64748b; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .dot { width: 8px; height: 8px; background: #475569; border-radius: 50%; }
        .dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <a href="../section_outils.html" class="nav-back">← Retour</a>

    <div class="tuner-container">
        <h2 style="margin:0; color:#cbd5e1; font-weight:600">Accordeur</h2>

        <div class="note-display" id="noteDisplay">--</div>
        <div class="frequency" id="freqDisplay">0.0 Hz</div>

        <div class="gauge-wrapper">
            <div class="center-line"></div>
            <div class="needle" id="needle"></div>
        </div>

        <div class="indicators">
            <span>♭ Trop Bas</span>
            <span>Trop Haut ♯</span>
        </div>

        <button class="btn-start" id="startBtn" onclick="startTuner()">Activer le Micro</button>

        <div class="mic-status">
            <div class="dot" id="micDot"></div>
            <span id="statusText">Micro désactivé</span>
        </div>
    </div>

<script>
    // --- AUDIO & LOGIC ---
    let audioContext = null;
    let analyser = null;
    let isRunning = false;
    const noteStrings = ["Do", "Do#", "Ré", "Ré#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];

    const noteDisplay = document.getElementById('noteDisplay');
    const freqDisplay = document.getElementById('freqDisplay');
    const needle = document.getElementById('needle');
    const startBtn = document.getElementById('startBtn');
    const micDot = document.getElementById('micDot');
    const statusText = document.getElementById('statusText');

    async function startTuner() {
        if (isRunning) return;

        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioContext.createMediaStreamSource(stream);

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            source.connect(analyser);

            isRunning = true;
            startBtn.style.display = 'none'; // Cache le bouton une fois lancé
            micDot.classList.add('active');
            statusText.textContent = "Écoute en cours...";

            updatePitch();
        } catch (err) {
            alert("Impossible d'accéder au micro. Vérifiez vos permissions.");
            console.error(err);
        }
    }

    let lastNoteTime = 0; // Mémoire anti-clignotement

    function updatePitch() {
        if (!isRunning) return;

        const bufferLength = analyser.fftSize;
        const buffer = new Float32Array(bufferLength);
        analyser.getFloatTimeDomainData(buffer);

        const frequency = autoCorrelate(buffer, audioContext.sampleRate);

        if (frequency === -1) {
            // SILENCE DÉTECTÉ
            // On attend 500ms (demi-seconde) avant de cacher l'aiguille.
            // Ça permet de lisser les micro-coupures quand tu joues.
            if (Date.now() - lastNoteTime > 500) {
                noteDisplay.style.opacity = "0.3";
                freqDisplay.textContent = "...";
                needle.style.opacity = "0";
            }
        } else {
            // NOTE DÉTECTÉE
            lastNoteTime = Date.now(); // On rafraîchit le chrono

            noteDisplay.style.opacity = "1";
            needle.style.opacity = "1";

            const note = getNote(frequency);
            const noteName = noteStrings[note % 12];

            const idealFreq = 440 * Math.pow(2, (note - 69) / 12);
            const cents = 1200 * Math.log2(frequency / idealFreq);

            noteDisplay.textContent = noteName;
            freqDisplay.textContent = frequency.toFixed(1) + " Hz";

            updateNeedle(cents);
        }

        requestAnimationFrame(updatePitch);
    }

    function updateNeedle(cents) {
        // Limiter l'affichage à +/- 50 cents
        let clampCents = Math.max(-50, Math.min(50, cents));

        // Convertir -50..50 en pourcentage 0..100% (50% = centre)
        const percent = ((clampCents + 50) / 100) * 100;

        needle.style.left = percent + "%";

        // Feedback visuel si c'est juste (+/- 5 cents)
        if (Math.abs(cents) < 5) {
            needle.classList.add('centered');
            noteDisplay.classList.add('in-tune');
        } else {
            needle.classList.remove('centered');
            noteDisplay.classList.remove('in-tune');
        }
    }

    // --- ALGORITHME DE DÉTECTION (AUTOCORRELATION) ---
    // C'est la méthode la plus fiable pour un accordeur de guitare
    function autoCorrelate(buf, sampleRate) {
        let SIZE = buf.length;
        let rms = 0;

        // 1. Calcul du volume (RMS)
        for (let i = 0; i < SIZE; i++) {
            let val = buf[i];
            rms += val * val;
        }
        rms = Math.sqrt(rms / SIZE);

        // SEUIL VOLUME : 0.01 est un bon équilibre
        if (rms < 0.01) return -1;

        // 2. Recherche de fréquence
        let r1 = 0, r2 = SIZE - 1, thres = 0.2;
        for (let i = 0; i < SIZE / 2; i++) {
            if (Math.abs(buf[i]) < thres) { r1 = i; break; }
        }
        for (let i = 1; i < SIZE / 2; i++) {
            if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
        }

        buf = buf.slice(r1, r2);
        SIZE = buf.length;

        let c = new Array(SIZE).fill(0);
        for (let i = 0; i < SIZE; i++) {
            for (let j = 0; j < SIZE - i; j++) {
                c[i] = c[i] + buf[j] * buf[j + i];
            }
        }

        let d = 0;
        while (c[d] > c[d + 1]) d++;
        let maxval = -1, maxpos = -1;
        for (let i = d; i < SIZE; i++) {
            if (c[i] > maxval) {
                maxval = c[i];
                maxpos = i;
            }
        }
        let T0 = maxpos;

        // SEUIL QUALITÉ : 0.8 filtre le bruit blanc mais garde la guitare
        let correlationQuality = maxval / c[0];
        if (correlationQuality < 0.8) return -1;

        // Interpolation
        let x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
        let a = (x1 + x3 - 2 * x2) / 2;
        let b = (x3 - x1) / 2;
        if (a) T0 = T0 - b / (2 * a);

        return sampleRate / T0;
    }


    function getNote(frequency) {
        const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
        return Math.round(noteNum) + 69;
    }
</script>

</body>
</html>