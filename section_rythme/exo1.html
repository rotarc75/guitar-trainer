<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Calibrateur</title>
    <style>
        :root {
            --primary: #f59e0b; /* Orange Rythme */
            --bg-dark: #0f172a;
            --text-main: #f1f5f9;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0;
            user-select: none;
        }

        /* RETOUR */
        .nav-back {
            position: absolute; top: 20px; left: 20px;
            text-decoration: none; color: #94a3b8; font-weight: 600;
            padding: 8px 15px; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; transition: 0.2s;
        }
        .nav-back:hover { color: white; background: rgba(255,255,255,0.1); }

        /* LE CŒUR DU SYSTÈME */
        .beat-indicator {
            width: 150px; height: 150px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 4px solid #334155;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: bold; color: #64748b;
            transition: transform 0.1s, border-color 0.1s, background 0.1s;
            margin-bottom: 40px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* ANIMATIONS ET ÉTATS */
        .beat-indicator.pulse { transform: scale(1.1); border-color: white; box-shadow: 0 0 50px rgba(255,255,255,0.2); }
        .beat-indicator.perfect { border-color: #10b981; background: rgba(16, 185, 129, 0.2); color: #10b981; } /* Vert */
        .beat-indicator.good { border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); color: #3b82f6; } /* Bleu */
        .beat-indicator.bad { border-color: #ef4444; background: rgba(239, 68, 68, 0.2); color: #ef4444; } /* Rouge */

        /* CONTROLES */
        .controls {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px 40px; border-radius: 20px;
            display: flex; gap: 20px; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        input[type="number"] {
            background: rgba(0,0,0,0.3); border: 1px solid #475569;
            color: white; padding: 10px; border-radius: 8px;
            font-size: 1.2rem; width: 80px; text-align: center;
        }

        button {
            background: var(--primary); color: white; border: none;
            padding: 12px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: 0.2s;
        }
        button:hover { transform: scale(1.05); filter: brightness(1.1); }
        button.stop { background: #ef4444; }

        /* FEEDBACK TEXTE */
        .feedback-text {
            font-size: 1.5rem; height: 30px; margin-bottom: 10px; font-weight: bold;
            text-align: center;
        }
        .offset-text {
            font-family: monospace; color: #94a3b8; margin-bottom: 30px;
        }

        .hint { margin-top: 30px; color: #64748b; font-size: 0.9rem; }

    </style>
</head>
<body>

    <a href="../section_rythme.html" class="nav-back">← Retour</a>

    <div class="feedback-text" id="feedbackMsg"></div>
    <div class="offset-text" id="offsetMsg">En attente...</div>

    <div class="beat-indicator" id="beatCircle">
        TAP
    </div>

    <div class="controls">
        <label>BPM :</label>
        <input type="number" id="bpmInput" value="100" min="40" max="240">
        <button id="startBtn" onclick="toggleMetronome()">Démarrer</button>
    </div>

    <div class="hint">Appuyez sur ESPACE pour taper le rythme</div>

<script>
    let audioCtx;
    let isRunning = false;
    let nextNoteTime = 0.0;
    let timerID = null;
    let bpm = 100;

    // Le coeur de la précision : AudioContext
    const lookahead = 25.0; // On regarde 25ms devant
    const scheduleAheadTime = 0.1; // On planifie 0.1s devant

    let lastBeatTime = 0; // Pour calculer le décalage de la frappe

    const circle = document.getElementById('beatCircle');
    const startBtn = document.getElementById('startBtn');
    const feedbackMsg = document.getElementById('feedbackMsg');
    const offsetMsg = document.getElementById('offsetMsg');

    function nextNote() {
        const secondsPerBeat = 60.0 / bpm;
        nextNoteTime += secondsPerBeat;
        lastBeatTime = nextNoteTime; // On garde en mémoire le temps théorique
    }

    function scheduleNote(time) {
        // 1. Le Son (Click court et précis)
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.frequency.value = 1000; // Son aigu
        gain.gain.value = 0.5;
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(time);
        osc.stop(time + 0.05);

        // 2. L'animation visuelle (synchro avec le son)
        // On utilise setTimeout pour l'UI, calculé par rapport au temps AudioContext
        const drawTime = (time - audioCtx.currentTime) * 1000;
        setTimeout(() => {
            pulseCircle();
        }, drawTime);
    }

    function scheduler() {
        // Tant qu'il y a des notes à jouer dans la fenêtre de temps
        while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
            scheduleNote(nextNoteTime);
            nextNote();
        }
        timerID = window.setTimeout(scheduler, lookahead);
    }

    function toggleMetronome() {
        if (isRunning) {
            // STOP
            window.clearTimeout(timerID);
            isRunning = false;
            startBtn.innerText = "Démarrer";
            startBtn.classList.remove('stop');
            offsetMsg.innerText = "Arrêté";
            circle.className = "beat-indicator";
        } else {
            // START
            bpm = parseInt(document.getElementById('bpmInput').value);
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            nextNoteTime = audioCtx.currentTime + 0.1;
            isRunning = true;
            startBtn.innerText = "Stop";
            startBtn.classList.add('stop');
            scheduler();
            offsetMsg.innerText = "Écoutez le tempo...";
        }
    }

    // --- ANIMATIONS ---
    function pulseCircle() {
        circle.classList.add('pulse');
        setTimeout(() => circle.classList.remove('pulse'), 100);
    }

    function visualFeedback(quality) {
        // quality: 'perfect', 'good', 'bad'
        circle.className = "beat-indicator " + quality;
        setTimeout(() => {
            if(isRunning) circle.className = "beat-indicator";
        }, 200);
    }

    // --- GESTION DU TAP (ESPACE) ---
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && isRunning) {
            e.preventDefault(); // Empêcher le scroll
            checkAccuracy();
        }
    });

    function checkAccuracy() {
        const currentTime = audioCtx.currentTime;
        const secondsPerBeat = 60.0 / bpm;

        // On cherche le temps du "Click" le plus proche
        // Est-ce le click d'avant ? ou celui qui arrive ?

        // Calcul mathématique pour trouver le "beat" théorique le plus proche
        // On calcule combien de beats se sont écoulés depuis le début
        // round() permet de trouver l'entier le plus proche (donc le beat le plus proche)
        // Mais comme nextNoteTime avance, on peut utiliser lastBeatTime (le prochain click)
        // et lastBeatTime - secondsPerBeat (le click d'avant).

        // Option plus simple : Delta avec le "grid"
        // Temps écoulé depuis le dernier "Start" théorique n'est pas fiable si on change le tempo.
        // Utilisons la grille relative.

        // Distance avec le prochain click
        const distToNext = Math.abs(currentTime - nextNoteTime);
        // Distance avec le click précédent (nextNoteTime - 1 beat)
        const distToPrev = Math.abs(currentTime - (nextNoteTime - secondsPerBeat));

        let diff = 0;
        let isLate = false;

        // On détermine si on est plus proche du précédent ou du suivant
        if (distToPrev < distToNext) {
            // On visait le click d'avant (donc on est en retard)
            diff = distToPrev;
            isLate = true;
        } else {
            // On vise le click qui arrive (donc on est en avance)
            diff = distToNext;
            isLate = false;
        }

        const diffMs = Math.round(diff * 1000);
        const sign = isLate ? "+" : "-"; // + = Retard, - = Avance

        // Affichage
        offsetMsg.innerText = `${sign}${diffMs} ms`;

        // Jugement
        if (diffMs < 35) {
            feedbackMsg.innerText = "PARFAIT !";
            feedbackMsg.style.color = "#10b981";
            visualFeedback('perfect');
        } else if (diffMs < 70) {
            feedbackMsg.innerText = "Bien";
            feedbackMsg.style.color = "#3b82f6";
            visualFeedback('good');
        } else {
            feedbackMsg.innerText = isLate ? "Trop Tard" : "Trop Tôt";
            feedbackMsg.style.color = "#ef4444";
            visualFeedback('bad');
        }
    }
</script>
</body>
</html>